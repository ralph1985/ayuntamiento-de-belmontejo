---
import { render } from 'astro:content';
import { Image } from 'astro:assets';
import client from '@data/client.json';
import { formatDate } from '@js/utils';
import BaseLayout from '@layouts/BaseLayout.astro';
import FeaturedContent from '@components/sections/FeaturedContent.astro';
import TableOfContents from '@components/content/TableOfContents.astro';
import CTA from '@components/sections/CTA.astro';
import Button from '@components/ui/Button.astro';
import '@styles/markdown.less';

const { post } = Astro.props;
const { title, date, description, image, imageAlt, author, category, link } =
  post.data;
const { Content, headings } = await render(post);
const baseSiteUrl =
  Astro.site && Astro.site.length > 0 ? Astro.site : client.domain;
const normalizedBaseUrl = baseSiteUrl.endsWith('/')
  ? baseSiteUrl
  : `${baseSiteUrl}/`;
const canonicalUrl = new URL(Astro.url.pathname, normalizedBaseUrl).href;
const imageSrc =
  typeof image === 'string'
    ? image
    : typeof image === 'object' && image?.src
      ? image.src
      : undefined;
const featuredImageUrl = imageSrc
  ? new URL(imageSrc, normalizedBaseUrl).href
  : undefined;
const publisherLogoUrl = new URL(
  '/assets/favicons/android-chrome-192x192.png',
  normalizedBaseUrl
).href;
const updatedAt = post.data.updatedAt ?? date;
const articleSchema = {
  '@context': 'https://schema.org',
  '@type': 'NewsArticle',
  headline: title,
  description,
  inLanguage: 'es',
  isAccessibleForFree: true,
  mainEntityOfPage: canonicalUrl,
  url: canonicalUrl,
  articleSection: category || 'Bandos',
  datePublished: new Date(date).toISOString(),
  dateModified: new Date(updatedAt).toISOString(),
  ...(featuredImageUrl && { image: [featuredImageUrl] }),
  ...(post.body && { articleBody: post.body }),
  author: author
    ? { '@type': 'Person', name: author }
    : { '@type': 'Organization', name: client.name },
  publisher: {
    '@type': 'Organization',
    name: client.name,
    logo: {
      '@type': 'ImageObject',
      url: publisherLogoUrl,
    },
  },
  identifier: post.data.guid || post.id,
  ...(link && { sameAs: [link] }),
};
---

<BaseLayout title={title} description={description} preloadedImage={image}>
  <!-- ============================================ -->
  <!--         Bando Article + Sidebar layout        -->
  <!-- ============================================ -->

  <div class="news-container">
    <!--Main content -->
    <section class="main-content">
      <article class="news-article">
        <script
          type="application/ld+json"
          is:inline
          set:html={JSON.stringify(articleSchema)}
        />
        <!--Article Info-->
        <header class="news-header">
          <h1 class="news-h1">{title}</h1>
          <div class="news-authorGroup">
            <!--Author Image-->
            <picture class="news-author-img">
              <img
                src="/assets/svgs/profile.svg"
                alt="house"
                width="32"
                height="32"
                decoding="async"
              />
            </picture>
            <span class="news-author">{author}</span>
            <span aria-hidden="true" class="news-dot"></span>
            <!--Bando Date-->
            <span class="news-date">{formatDate(date)}</span>
            {
              category && (
                <>
                  <span aria-hidden="true" class="news-dot" />
                  <span class="news-category">{category}</span>
                </>
              )
            }
          </div>
        </header>

        <!--Main Article Image (optional for bandos)-->
        {
          image && (
            <picture class="news-mainImage">
              <Image
                src={image}
                alt={imageAlt || title}
                width="795"
                height="400"
                decoding="async"
              />
            </picture>
          )
        }

        <!-- Mobile Table of Contents -->
        <TableOfContents
          headings={headings}
          levels={3}
          hideOnMobile={false}
          noWrapper={false}
        />
        <!--Markdown content-->
        <div id="news-content">
          <Content />
        </div>

        {
          link && (
            <Button
              href={link}
              target="_blank"
              rel="noopener noreferrer"
              variant="ghost"
              class="bando-external-link"
            >
              Ver bando original en Bandomovil
            </Button>
          )
        }
      </article>
    </section>
    <!--Side bar-->
    <aside class="news-sidebar">
      <!-- Desktop Table of Contents -->
      <TableOfContents headings={headings} levels={3} />
      <!-- Featured Content -->
      <div class="news-sidebar_widget-wrapper">
        <FeaturedContent type="bandos" limit={3} excludeCurrentPost={post.id} />
      </div>
    </aside>
  </div>

  <CTA />
</BaseLayout>

<style lang="less">
  @import '../styles/layouts/bando-post-layout.less';
</style>
