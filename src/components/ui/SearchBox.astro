<div class="search-container">
  <div class="search-input-wrapper">
    <input
      type="text"
      id="search-input"
      placeholder="Buscar en noticias y bandos..."
      class="search-input"
    />
    <button id="search-button" class="search-button" aria-label="Buscar">
      <svg class="search-icon" viewBox="0 0 24 24" width="20" height="20">
        <path
          fill="currentColor"
          d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"
        ></path>
      </svg>
    </button>
  </div>

  <div id="search-results" class="search-results" style="display: none;">
    <div id="search-loading" class="search-loading" style="display: none;">
      Buscando...
    </div>
    <div
      id="search-no-results"
      class="search-no-results"
      style="display: none;"
    >
      No se encontraron resultados
    </div>
    <div id="search-results-list" class="search-results-list"></div>
  </div>
</div>

<style is:global>
  @import '../../styles/components/search-box.less';
</style>

<script>
  interface SearchItem {
    id: string;
    type: string;
    title: string;
    description: string;
    author: string;
    date: string;
    url: string;
    content: string;
    category?: string;
    tags: string[];
  }

  let searchData: SearchItem[] = [];
  let isDataLoaded = false;

  function saveSearchState(query: string, results: SearchItem[]) {
    const state = { query, results, timestamp: Date.now() };
    localStorage.setItem('searchState', JSON.stringify(state));
  }

  function loadSearchState() {
    try {
      const saved = localStorage.getItem('searchState');
      if (!saved) return null;

      const state = JSON.parse(saved);
      if (Date.now() - state.timestamp > 3600000) {
        localStorage.removeItem('searchState');
        return null;
      }

      return state;
    } catch (error) {
      // eslint-disable-next-line no-console
      console.error('Error loading search state:', error);
      return null;
    }
  }

  function clearSearchState() {
    localStorage.removeItem('searchState');
  }

  async function loadSearchData() {
    if (isDataLoaded) return;

    try {
      const response = await fetch('/api/search-data.json');
      if (!response.ok) throw new Error('Error al cargar datos de bÃºsqueda');

      searchData = await response.json();
      isDataLoaded = true;
    } catch (error) {
      // eslint-disable-next-line no-console
      console.error('Error loading search data:', error);
    }
  }

  function highlightSearchTerms(text: string, query: string): string {
    const searchTerms = query
      .toLowerCase()
      .trim()
      .split(' ')
      .filter(term => term.length > 0);

    return searchTerms.reduce((acc, term) => {
      const regex = new RegExp(`(${term})`, 'gi');
      return acc.replace(regex, '<mark>$1</mark>');
    }, text);
  }

  function mountSearchBox() {
    const searchInput = document.getElementById(
      'search-input'
    ) as HTMLInputElement | null;
    const searchButton = document.getElementById(
      'search-button'
    ) as HTMLButtonElement | null;
    const searchResults = document.getElementById(
      'search-results'
    ) as HTMLElement | null;
    const searchLoading = document.getElementById(
      'search-loading'
    ) as HTMLElement | null;
    const searchNoResults = document.getElementById(
      'search-no-results'
    ) as HTMLElement | null;
    const searchResultsList = document.getElementById(
      'search-results-list'
    ) as HTMLElement | null;

    if (
      !searchInput ||
      !searchButton ||
      !searchResults ||
      !searchLoading ||
      !searchNoResults ||
      !searchResultsList ||
      searchInput.dataset.enhanced === 'true'
    ) {
      return;
    }

    searchInput.dataset.enhanced = 'true';

    let searchTimeout: ReturnType<typeof setTimeout>;

    function hideSearchResults() {
      if (!searchInput.value.trim()) {
        searchResults.style.display = 'none';
      }
    }

    function displaySearchResults(results: SearchItem[], query: string) {
      searchResults.style.display = 'block';
      searchLoading.style.display = 'none';
      saveSearchState(query, results);

      if (results.length === 0) {
        searchNoResults.style.display = 'block';
        searchResultsList.innerHTML = '';
        return;
      }

      searchNoResults.style.display = 'none';

      const resultsHTML = results
        .slice(0, 10)
        .map(item => {
          const date = new Date(item.date).toLocaleDateString('es-ES', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
          });

          const highlightedTitle = highlightSearchTerms(item.title, query);
          const highlightedDescription = highlightSearchTerms(
            item.description.length > 150
              ? item.description.substring(0, 150) + '...'
              : item.description,
            query
          );

          return `<div class="search-result-item" onclick="window.location.href='${item.url}'">
            <div class="search-result-title">${highlightedTitle}</div>
            <div class="search-result-description">${highlightedDescription}</div>
            <div class="search-result-meta">
              <span class="search-result-type ${item.type}">${item.type}</span>
              <span class="search-result-date">${date}</span>
              <span class="search-result-author">${item.author}</span>
            </div>
          </div>`;
        })
        .join('');

      searchResultsList.innerHTML = resultsHTML;
    }

    function performSearch(query: string) {
      if (!query.trim()) {
        hideSearchResults();
        return;
      }

      const normalizedQuery = query.toLowerCase().trim();
      const searchTerms = normalizedQuery
        .split(' ')
        .filter(term => term.length > 0);

      const results = searchData.filter(item => {
        const searchableText = [
          item.title,
          item.description,
          item.content,
          item.author,
          ...(item.tags || []),
        ]
          .join(' ')
          .toLowerCase();

        return searchTerms.every(term => searchableText.includes(term));
      });

      displaySearchResults(results, query);
    }

    function initializeSearch() {
      const savedState = loadSearchState();
      if (savedState && savedState.query && savedState.results) {
        searchInput.value = savedState.query;
        displaySearchResults(savedState.results, savedState.query);
      }
    }

    searchInput.addEventListener('input', event => {
      clearTimeout(searchTimeout);
      const query = (event.target as HTMLInputElement).value;

      if (query.trim()) {
        searchLoading.style.display = 'block';
        searchNoResults.style.display = 'none';
        searchResultsList.innerHTML = '';
        searchResults.style.display = 'block';

        searchTimeout = setTimeout(() => {
          performSearch(query);
        }, 300);
      } else {
        hideSearchResults();
        clearSearchState();
      }
    });

    searchButton.addEventListener('click', () => {
      const query = searchInput.value;
      if (query.trim()) {
        performSearch(query);
      }
    });

    searchInput.addEventListener('focus', loadSearchData);

    searchInput.addEventListener('keydown', event => {
      if (event.key === 'Enter') {
        event.preventDefault();
        const query = searchInput.value;
        if (query.trim()) {
          performSearch(query);
        }
      }
    });

    loadSearchData().then(() => {
      initializeSearch();
    });
  }

  ['astro:page-load', 'astro:after-swap'].forEach(eventName => {
    document.addEventListener(eventName, mountSearchBox);
  });

  mountSearchBox();
</script>

<style is:global>
  mark {
    background-color: rgba(255, 235, 59, 0.3);
    color: inherit;
    padding: 1px 3px;
    border-radius: 3px;
    font-weight: 600;
  }
</style>
