---
import BaseLayout from '@layouts/BaseLayout.astro';
import contactInfo from '@js/contact';
import Landing from '@components/sections/Landing.astro';
import Button from '@components/ui/Button.astro';

// Optimize our landing image and pass it as props to the BaseLayout (for preloading) and Landing (for rendering)
import landingImage from '@assets/images/vista-aerea-2.jpg'; // <-- THE PATH TO THE ASSET YOU WANT TO PRELOAD - The asset must live in src
import { getImage } from 'astro:assets';
const optimizedImage = await getImage({ src: landingImage, format: 'avif' });
const contactPageTitle = `Contacto - ${contactInfo.entity.name}`;
const contactPageDescription = `Ponte en contacto con el ${contactInfo.entity.name}. Información de contacto actualizada, direcciones y formulario para consultas ciudadanas.`;
const phones = contactInfo.contact?.phones ?? [];
const emails = contactInfo.contact?.emails ?? [];
const offices = (contactInfo.offices ?? []).map(office => ({
  ...office,
  lines: [
    office.street,
    [office.locality, office.region].filter(Boolean).join(', '),
    office.postalCode,
  ].filter(Boolean),
}));
---

<BaseLayout
  title={contactPageTitle}
  description={contactPageDescription}
  preloadedImage={optimizedImage}
>
  <!-- ============================================ -->
  <!--                    LANDING                   -->
  <!-- ============================================ -->

  <Landing title="Contacto" image={optimizedImage}>
    <p>
      Ponte en contacto con el {contactInfo.entity.name} para consultas, sugerencias
      y trámites municipales.
    </p>
  </Landing>

  <!-- ============================================ -->
  <!--                Contact Form                  -->
  <!-- ============================================ -->

  <section id="cs-contact">
    <div class="cs-container">
      <form id="cs-form" name="Contact Form" method="post" novalidate>
        <div class="cs-content">
          <span class="cs-topper">Contacto</span>
          <h2 class="cs-title">
            Ponte en contacto con el {contactInfo.entity.name}
          </h2>
          <p class="cs-text">
            El {contactInfo.entity.name} está aquí para atender tus consultas, sugerencias
            y trámites administrativos. No dudes en contactarnos para cualquier asunto
            relacionado con nuestro municipio. Estaremos encantados de ayudarte.
          </p>
        </div>
        <label>
          Nombre
          <input
            required
            type="text"
            id="name"
            name="name"
            placeholder="Nombre completo"
          />
        </label>
        <label>
          Correo electrónico
          <input
            required
            type="email"
            id="email"
            name="email"
            placeholder="tu@email.com"
          />
        </label>
        <label>
          Teléfono
          <input
            required
            type="tel"
            id="phone"
            name="phone"
            placeholder="Número de teléfono"
          />
        </label>
        <label>
          Asunto
          <input
            type="text"
            id="find"
            name="subject"
            placeholder="Motivo de la consulta"
          />
        </label>
        <label class="cs-label-message">
          Mensaje
          <textarea
            required
            name="message"
            id="message"
            placeholder="Escribe tu mensaje aquí..."></textarea>
        </label>
        <Button type="submit">Enviar mensaje</Button>
        <p
          class="cs-form-status"
          data-form-status
          aria-live="polite"
          role="status"
        >
        </p>
      </form>
      <div class="cs-right-section">
        {
          emails.map(email => (
            <>
              <span class="cs-header">{email.label}</span>
              <a class="cs-link" href={`mailto:${email.address}`}>
                {email.address}
              </a>
            </>
          ))
        }
        {
          phones.map(phone => (
            <>
              <span class="cs-header">{phone.label}</span>
              <a class="cs-link" href={`tel:${phone.href}`}>
                {phone.display}
              </a>
            </>
          ))
        }
        {
          offices.map(office => (
            <>
              <span class="cs-header">{office.label}</span>
              {office.mapsUrl ? (
                <a class="cs-link" href={office.mapsUrl}>
                  {office.lines.map((line, index) => {
                    const isLastLine = index === office.lines.length - 1;

                    return (
                      <>
                        <span class={isLastLine ? 'cs-block' : undefined}>
                          {line}
                        </span>
                        {!isLastLine && <br />}
                      </>
                    );
                  })}
                </a>
              ) : (
                <span class="cs-link">
                  {office.lines.map((line, index) => {
                    const isLastLine = index === office.lines.length - 1;

                    return (
                      <>
                        <span class={isLastLine ? 'cs-block' : undefined}>
                          {line}
                        </span>
                        {!isLastLine && <br />}
                      </>
                    );
                  })}
                </span>
              )}
            </>
          ))
        }

        <!-- Background Image-->
        <picture class="cs-bg-picture">
          <source
            media="(min-width: 601px)"
            srcset="/assets/images/skyscraper.jpg"
          />
          <img
            aria-hidden="true"
            decoding="async"
            src="/assets/images/skyscraper.jpg"
            alt="building"
            loading="lazy"
            width="2500"
            height="1667"
          />
        </picture>
      </div>
    </div>
  </section>
</BaseLayout>

<script>
  type FormStatus = 'idle' | 'pending' | 'success' | 'error';

  const getStatusMessage = (variant: FormStatus): string => {
    switch (variant) {
      case 'pending':
        return 'Enviando tu mensaje...';
      case 'success':
        return '¡Gracias! Hemos recibido tu mensaje y te responderemos pronto.';
      case 'error':
        return 'No se ha podido enviar el mensaje. Inténtalo de nuevo.';
      default:
        return '';
    }
  };

  const updateStatus = (
    element: HTMLElement | null,
    variant: FormStatus,
    customMessage?: string
  ) => {
    if (!element) return;
    element.dataset.status = variant;
    element.textContent = customMessage ?? getStatusMessage(variant);
  };

  const toJsonPayload = (form: HTMLFormElement) => {
    const formData = new FormData(form);
    const getValue = (field: string) =>
      (formData.get(field)?.toString() ?? '').trim();

    return {
      name: getValue('name'),
      email: getValue('email'),
      phone: getValue('phone'),
      subject: getValue('subject') || 'Consulta desde la web',
      message: getValue('message'),
    };
  };

  const mountContactForm = () => {
    const form = document.getElementById('cs-form') as HTMLFormElement | null;

    if (!form || form.dataset.enhanced === 'true') return;

    const submitButton = form.querySelector(
      'button[type="submit"]'
    ) as HTMLButtonElement | null;
    const statusElement = form.querySelector(
      '[data-form-status]'
    ) as HTMLElement | null;

    form.dataset.enhanced = 'true';

    form.addEventListener('submit', async event => {
      event.preventDefault();

      if (!submitButton) return;

      updateStatus(statusElement, 'pending');
      submitButton.disabled = true;
      submitButton.setAttribute('aria-busy', 'true');

      try {
        const response = await fetch('/api/contacto.json', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(toJsonPayload(form)),
        });

        const result = await response.json().catch(() => ({}));

        if (!response.ok || !result?.success) {
          throw new Error(
            result?.error ??
              'No se pudo enviar el mensaje. Inténtalo más tarde.'
          );
        }

        updateStatus(statusElement, 'success');
        form.reset();
      } catch (error) {
        updateStatus(
          statusElement,
          'error',
          error instanceof Error ? error.message : undefined
        );
      } finally {
        submitButton.disabled = false;
        submitButton.removeAttribute('aria-busy');
      }
    });
  };

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', mountContactForm, {
      once: true,
    });
  } else {
    mountContactForm();
  }

  document.addEventListener('astro:after-swap', mountContactForm);
</script>

<style lang="less">
  @import '../styles/pages/contacto.less';
</style>
