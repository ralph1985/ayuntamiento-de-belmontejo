# Optimizaci√≥n de CSS - Gu√≠a Completa

## üéØ Objetivo

Este proyecto implementa un sistema de **poda y minificado selectivo de CSS** que:

1. **Elimina clases CSS no usadas** (PurgeCSS)
2. **Protege la capa `@layer legacy`** para evitar romper estilos existentes
3. **Minifica el CSS final** (cssnano + autoprefixer)
4. **Proporciona an√°lisis detallado** antes de aplicar cambios

---

## üì¶ Dependencias Instaladas

```bash
npm install --save-dev @fullhuman/postcss-purgecss purgecss cssnano postcss-cli
```

### Herramientas

- **PurgeCSS**: Elimina CSS no usado analizando los archivos fuente
- **cssnano**: Minifica CSS (optimiza colores, combina reglas, etc.)
- **autoprefixer**: A√±ade prefijos de navegador autom√°ticamente
- **postcss-cli**: Ejecuta PostCSS desde l√≠nea de comandos

---

## üèóÔ∏è Arquitectura CSS

El proyecto usa **ITCSS con CSS Cascade Layers**:

```less
@layer base, components, utilities, legacy;

@layer base {
  /* Variables, reset, elementos base */
}
@layer components {
  /* Componentes reutilizables */
}
@layer utilities {
  /* Utilidades at√≥micas: u-flex, u-mt-sm */
}
@layer legacy {
  /* C√≥digo existente - NO SE PURGA */
}
```

### ¬øPor qu√© NO purgar `@layer legacy`?

- Contiene estilos heredados que pueden no estar completamente documentados
- Evita romper estilos durante la migraci√≥n progresiva a componentes BEM
- Se purgar√° en futuras iteraciones cuando todo est√© migrado a components

---

## üöÄ Scripts Disponibles

### 1. An√°lisis (Dry-run)

**Recomendado ejecutar ANTES de cualquier refactor grande**

```bash
npm run purge:dry
```

**¬øQu√© hace?**

- Ejecuta un an√°lisis **sin modificar archivos**
- Genera reportes en `dist/purge-analysis/`
- Muestra qu√© CSS se eliminar√≠a y cu√°nto espacio se ahorrar√≠a

**Salida:**

```
dist/purge-analysis/
  ‚îú‚îÄ‚îÄ main.abc123.analysis.txt  # Reporte detallado
  ‚îî‚îÄ‚îÄ rejected.css               # CSS que se eliminar√≠a
```

**Cu√°ndo usar:**

- Antes de un gran refactor de componentes
- Para identificar CSS muerto
- Para validar que no se eliminan clases necesarias

---

### 2. Aplicar Purgado

```bash
npm run purge:apply
```

**¬øQu√© hace?**

- Ejecuta PurgeCSS y **MODIFICA** los archivos CSS en `dist/`
- Protege `@layer legacy` completamente
- Aplica safelist de clases protegidas

**‚ö†Ô∏è IMPORTANTE:**

- Solo afecta archivos en `dist/` (no modifica c√≥digo fuente)
- Ejecuta `npm run build` primero para regenerar desde cero

---

### 3. Minificar CSS

```bash
npm run build:css
```

**¬øQu√© hace?**

- Minifica CSS con cssnano (solo en producci√≥n)
- Aplica autoprefixer para compatibilidad de navegadores
- NO purga clases (solo comprime)

**Optimizaciones aplicadas:**

- Elimina comentarios
- Optimiza colores: `#ffffff` ‚Üí `#fff`
- Combina reglas duplicadas
- Minifica selectores y media queries

---

### 4. Pipeline Completo (Recomendado para Producci√≥n)

```bash
npm run optimize:css
```

**Pipeline:**

1. `npm run build` - Compila Astro + LESS
2. `npm run purge:apply` - Elimina CSS no usado
3. `npm run build:css` - Minifica resultado final

**Resultado:**

- CSS optimizado en `dist/_astro/*.css`
- Tama√±o reducido ~30-50% (estimado)

---

### 5. An√°lisis Completo

```bash
npm run analyze:css
```

**¬øQu√© hace?**

- Compila el proyecto
- Genera an√°lisis sin modificar archivos
- Perfecto para CI/CD o revisi√≥n peri√≥dica

---

## üõ°Ô∏è Safelist - Clases Protegidas

El sistema **NUNCA eliminar√°** estas clases:

### Patrones Est√°ndar

```javascript
/^data-theme/     // data-theme="dark"
/^dark-mode$/     // body.dark-mode (legacy)
/^is-/            // is-active, is-open, is-visible
/^has-/           // has-error, has-warning
/^js-/            // js-menu-toggle (hooks de JS)
/^astro-/         // Clases generadas por Astro
```

### Patrones Deep (incluye descendientes)

```javascript
/^u-/   // Todas las utilidades: u-flex, u-mt-sm, u-grid-cols-2
/^c-/   // Componentes BEM: c-card, c-button
/^cs-/  // CodeStitch: cs-topper, cs-title, cs-button
```

### Patrones Greedy (b√∫squeda agresiva)

```javascript
/dark/        // *dark* - Protege dark mode
/theme/       // *theme* - Protege temas
/transition/  // View Transitions de Astro
/cookie/      // Cookie consent
```

---

## üîß Configuraci√≥n

### PostCSS (`postcss.config.cjs`)

```javascript
// PurgeCSS solo se activa con PURGE_CSS=true
const isPurgeEnabled = process.env.PURGE_CSS === 'true';

// cssnano solo en producci√≥n
const isProduction = process.env.NODE_ENV === 'production';
```

### PurgeCSS Custom (`purgecss.config.js`)

Configuraci√≥n standalone para dry-runs con CLI de PurgeCSS.

### Script Node.js (`scripts/purge-css.js`)

**Funcionalidad avanzada:**

- Detecta autom√°ticamente `@layer` blocks en el CSS compilado
- Protege `@layer legacy` completamente
- Genera an√°lisis detallados con m√©tricas de ahorro
- Valida que `dist/_astro/` existe antes de procesar

---

## üìä M√©tricas Esperadas

### Antes de Optimizar

```
dist/_astro/main.abc123.css: ~150 KB
```

### Despu√©s de Purgar

```
Purgado: ~100 KB (-33%)
```

### Despu√©s de Minificar

```
Final: ~70 KB (-53% total)
```

**Nota:** Los n√∫meros exactos dependen del contenido del sitio.

---

## üîç C√≥mo Revisar el An√°lisis

Despu√©s de `npm run purge:dry`:

### 1. Abrir Reporte

```bash
cat dist/purge-analysis/main.abc123.analysis.txt
```

### 2. Revisar M√©tricas

```
Tama√±o original: 150.23 KB
CSS purgado: 100.45 KB
Tama√±o final (con legacy): 120.78 KB
Ahorro: 49.78 KB (33.14%)
```

### 3. Verificar CSS Eliminado

```
CSS ELIMINADO (muestra):
.clase-no-usada { color: red; }
.otro-selector-muerto { margin: 10px; }
```

### 4. Validar Clases Importantes

**Si ves una clase necesaria en "CSS ELIMINADO":**

1. A√±√°dela a la safelist en `postcss.config.cjs`
2. O usa un patr√≥n en `purgecss.config.js`
3. Vuelve a ejecutar `npm run purge:dry`

---

## üìù Ampliar la Safelist

### Caso 1: Proteger clase espec√≠fica

```javascript
// postcss.config.cjs
safelist: {
  standard: [
    'mi-clase-especial',
    /^otro-patron-/,
  ],
}
```

### Caso 2: Proteger familia de clases

```javascript
// postcss.config.cjs
safelist: {
  deep: [
    /^mis-componentes-/,  // mis-componentes-card, mis-componentes-button
  ],
}
```

### Caso 3: Proteger clases din√°micas de JS

```javascript
// postcss.config.cjs
safelist: {
  greedy: [
    /modal/,     // Protege todo lo relacionado con modals
    /dropdown/,  // Protege dropdowns
  ],
}
```

---

## üêõ Troubleshooting

### ‚ùå Error: "No se encontr√≥ dist/\_astro/"

**Soluci√≥n:**

```bash
npm run build  # Compila Astro primero
npm run purge:dry
```

### ‚ùå Clase necesaria eliminada

**Ejemplo:** `.my-dynamic-class` generada por JS desaparece.

**Soluci√≥n:**

```javascript
// postcss.config.cjs
safelist: {
  standard: [/^my-dynamic-/],
}
```

### ‚ùå Dark mode roto despu√©s de purgar

**S√≠ntoma:** El modo oscuro no funciona correctamente.

**Causa:** Alguna clase de dark mode fue eliminada.

**Soluci√≥n:** Verifica la safelist:

```javascript
safelist: {
  greedy: [
    /dark/,  // Ya est√°, pero verifica
  ],
}
```

### ‚ùå El purgado no reduce el tama√±o

**Causa:** La mayor√≠a del CSS est√° en `@layer legacy` (protegida).

**Soluci√≥n:**

1. Migra m√°s estilos a `@layer components`
2. Revisa `src/styles/legacy/` y mueve lo posible a `components/`
3. Vuelve a ejecutar an√°lisis

---

## üéì Mejores Pr√°cticas

### 1. Ejecuta `purge:dry` Regularmente

```bash
# Cada viernes (review semanal)
npm run analyze:css
```

### 2. Antes de Grandes Refactors

```bash
# Antes
npm run purge:dry

# Refactor code...

# Despu√©s
npm run purge:dry
# Compara resultados
```

### 3. En CI/CD (Opcional)

```yaml
# .github/workflows/ci.yml
- name: Analyze CSS Size
  run: npm run analyze:css
```

### 4. Migraci√≥n Progresiva

```
Paso 1: Migrar componente de legacy a components
Paso 2: npm run purge:dry
Paso 3: Verificar que todo funciona
Paso 4: Repeat
```

---

## üìö Recursos Adicionales

- [PurgeCSS Docs](https://purgecss.com/)
- [cssnano Optimizations](https://cssnano.co/docs/optimisations/)
- [ITCSS Architecture](https://www.xfive.co/blog/itcss-scalable-maintainable-css-architecture/)
- [CSS Cascade Layers](https://developer.mozilla.org/en-US/docs/Web/CSS/@layer)

---

## üîÑ Flujo de Trabajo Recomendado

### Desarrollo Diario

```bash
npm run dev  # Sin optimizaciones
```

### Antes de Commit (opcional)

```bash
npm run lint:css:fix
npm run format:write
```

### Pre-deploy / Producci√≥n

```bash
npm run optimize:css  # Pipeline completo
npm run preview       # Verificar en local
# Deploy
```

### Review Mensual

```bash
npm run analyze:css
# Revisar dist/purge-analysis/
# Identificar CSS muerto
# Planear migraciones
```

---

## ‚öôÔ∏è Variables de Entorno

```bash
# Habilitar purgado en postcss.config.cjs
PURGE_CSS=true npm run build:css

# Forzar minificaci√≥n (producci√≥n)
NODE_ENV=production npm run build:css
```

---

## üéØ Pr√≥ximos Pasos

1. **Ejecuta an√°lisis inicial:**

   ```bash
   npm run analyze:css
   ```

2. **Revisa el reporte** en `dist/purge-analysis/`

3. **Ajusta safelist** si es necesario

4. **Aplica optimizaci√≥n:**

   ```bash
   npm run optimize:css
   ```

5. **Verifica el sitio:**

   ```bash
   npm run preview
   ```

6. **Documenta tus resultados** (tama√±o antes/despu√©s)

---

## üìû Contacto

Si encuentras problemas o tienes sugerencias, revisa:

- `docs/WHERE_MIGRATION_COMPLETE.md` - Migraci√≥n de especificidad
- `docs/UTILITIES_WHERE_SUMMARY.md` - Utilidades CSS
- `README.md` - Documentaci√≥n principal del proyecto
